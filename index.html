<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Service Ai</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7fa; margin: 0; padding: 0; }
        .container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 32px; }
        h1 { text-align: center; font-size: 2rem; margin-bottom: 12px; }
        .desc { color: #555; text-align: center; margin-bottom: 24px; }
        .btn { display: block; width: 100%; background: #4f8cff; color: #fff; border: none; border-radius: 8px; padding: 14px; font-size: 1.1rem; cursor: pointer; margin-bottom: 24px; transition: background 0.2s; }
        .btn:hover { background: #2563eb; }
        .step { margin-top: 24px; }
        label { font-weight: bold; display: block; margin-bottom: 6px; }
        textarea, input[type="file"] { width: 100%; border-radius: 6px; border: 1px solid #ccc; padding: 8px; font-size: 1rem; }
        textarea { min-height: 80px; }
        .footer { text-align: center; color: #aaa; margin-top: 32px; font-size: 0.95rem; }
        .nav-btns { display: flex; justify-content: space-between; gap: 10px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 18px; }
        .tab-btn { flex: 1; padding: 12px 0; background: #f1f5fb; border: none; border-radius: 8px 8px 0 0; font-size: 1.08rem; cursor: pointer; color: #4f8cff; font-weight: bold; transition: background 0.2s, color 0.2s; }
        .tab-btn.active { background: #fff; color: #222; box-shadow: 0 -2px 8px #0001; }
        .apps-list { display: flex; flex-wrap: wrap; gap: 24px; }
        .app-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 24px #4f8cff22, 0 1.5px 6px #0001;
            padding: 24px 20px 18px 20px;
            min-width: 220px;
            max-width: 240px;
            flex: 1 1 220px;
            perspective: 600px;
            transform: perspective(600px) rotateY(-6deg) scale(1.01);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }
        .app-card:hover {
            transform: perspective(600px) rotateY(6deg) scale(1.04);
            box-shadow: 0 16px 32px #4f8cff33, 0 2px 8px #0002;
            z-index: 2;
        }
        .app-title { font-size: 1.18rem; font-weight: bold; margin-bottom: 6px; }
        .app-meta { color: #888; font-size: 0.97em; margin-bottom: 8px; }
        .app-desc { color: #555; font-size: 1em; margin-bottom: 12px; }
        .app-link { color: #4f8cff; font-size: 0.99em; text-decoration: none; font-weight: bold; }
        .app-link:hover { text-decoration: underline; }
        #avatarPreview img {
            max-width: 64px;
            max-height: 64px;
            border-radius: 12px;
            box-shadow: 0 2px 8px #0002;
            margin-bottom: 6px;
        }
        .avatar-choices {
            display: flex;
            gap: 16px;
            margin-top: 6px;
            margin-bottom: 10px;
        }
        .avatar-option {
            font-size: 2.1rem;
            background: #f1f5fb;
            border-radius: 50%;
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px #0001;
            user-select: none;
        }
        .avatar-option.selected {
            border: 2.5px solid #4f8cff;
            box-shadow: 0 4px 16px #4f8cff22;
            background: #fff;
        }
        #appName {
            font-size: 1.13rem;
            padding: 12px 10px;
            border-radius: 8px;
            border: 1.5px solid #bcd0ee;
            margin-bottom: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.18);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            border-radius: 18px;
            padding: 32px 28px 24px 28px;
            max-width: 350px;
            margin: auto;
            box-shadow: 0 8px 32px #0002;
            position: relative;
            text-align: center;
            animation: modalIn 0.22s cubic-bezier(.4,1.6,.6,1);
        }
        @keyframes modalIn {
            from { transform: scale(0.92) translateY(30px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .close {
            position: absolute;
            right: 18px; top: 14px;
            font-size: 2rem;
            color: #bbb;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close:hover { color: #4f8cff; }
        .modal-avatar {
            font-size: 3.2rem;
            margin-bottom: 10px;
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .modal-date {
            color: #888;
            font-size: 0.98em;
            margin-bottom: 12px;
        }
        .modal-desc {
            color: #444;
            font-size: 1.05em;
            margin-bottom: 8px;
        }
        .app-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        .app-info-btn {
            background: #f1f5fb;
            border: none;
            border-radius: 50%;
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
            color: #4f8cff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .app-info-btn:hover { background: #e0eaff; }
        .app-info-btn.top-right {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
        }
        .chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f7f7fa;
            padding: 18px 18px 10px 18px;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 2px 8px #0001;
            font-size: 1.15rem;
            font-weight: bold;
        }
        .chat-avatar {
            font-size: 2rem;
            background: #fff;
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px #0001;
        }
        .chat-title { font-size: 1.13rem; font-weight: bold; }
        .chat-messages {
            min-height: 180px;
            max-height: 320px;
            overflow-y: auto;
            padding: 18px;
            background: #fff;
            border-radius: 12px;
            margin: 0 0 12px 0;
            box-shadow: 0 1px 4px #0001;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            max-width: 80%;
            word-break: break-word;
        }
        .chat-message.bot {
            background: #f1f5fb;
            color: #333;
            align-self: flex-start;
        }
        .chat-message.user {
            background: #4f8cff;
            color: #fff;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-input-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .chat-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1.2px solid #bcd0ee;
            font-size: 1.08rem;
        }
        .chat-send-btn {
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 18px;
            font-size: 1.08rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-send-btn:hover { background: #2563eb; }
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 18px;
            flex-wrap: wrap;
        }
        .modal-actions .btn {
            flex: 1 1 0;
            min-width: 120px;
            max-width: 180px;
            font-size: 1.08rem;
            padding: 14px 0;
        }
        @media (max-width: 500px) {
            .modal-actions {
                flex-direction: column;
                gap: 10px;
            }
            .modal-actions .btn {
                width: 100%;
                min-width: 0;
                max-width: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
    <script type="module">
      import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.13.0/dist/transformers.min.js';
      window.transformers = { pipeline };
    </script>
    <script>
        function showStep(step) {
            document.getElementById('main').style.display = (step === 0) ? 'block' : 'none';
            document.getElementById('step1').style.display = (step === 1) ? 'block' : 'none';
            document.getElementById('step2').style.display = (step === 2) ? 'block' : 'none';
            document.getElementById('step3').style.display = (step === 3) ? 'block' : 'none';
            document.getElementById('step4').style.display = (step === 4) ? 'block' : 'none';
        }
        function startWizard() {
            // Полный сброс всех данных мастера
            sessionStorage.removeItem('uploadedData');
            sessionStorage.removeItem('systemPrompt');
            sessionStorage.removeItem('ragChunks');
            sessionStorage.removeItem('ragEmbeddings');
            sessionStorage.removeItem('currentApp');
            sessionStorage.removeItem('editingAppIdx');
            sessionStorage.removeItem('editingColleagueAppIdx');
            showStep(1);
        }
        function toStep2() {
            // Сброс данных о файле при каждом входе на шаг 2
            sessionStorage.removeItem('uploadedData');
            sessionStorage.removeItem('systemPrompt');
            sessionStorage.removeItem('ragChunks');
            sessionStorage.removeItem('ragEmbeddings');
            showStep(2);
        }
        function backToStep1() { showStep(1); }
        function backToMain() { showStep(0); }
        function toStep3() {
            showStep(3);
            const datafileInput = document.getElementById('datafile');
            const file = datafileInput && datafileInput.files[0];
            const fileInfoDiv = document.getElementById('fileInfo') || createFileInfoDiv();
            if (file) {
                const ext = file.name.split('.').pop().toLowerCase();
                let icon = '📄';
                if (ext === 'csv') icon = '🟦';
                if (ext === 'txt') icon = '📄';
                if (ext === 'xlsx' || ext === 'xls') icon = '📊';
                if (ext === 'docx') icon = '📄';
                fileInfoDiv.innerHTML = `${icon} <b>${file.name}</b>`;
            } else {
                fileInfoDiv.innerHTML = '';
            }
            // Убираем диагностику на шаге 3
            const diagDiv = document.getElementById('fileDiag');
            if (diagDiv) diagDiv.innerHTML = '';
        }
        function createFileInfoDiv() {
            const div = document.createElement('div');
            div.id = 'fileInfo';
            div.style = 'margin: 10px 0 16px 0; font-size:1.08em; color:#444;';
            document.getElementById('step3').insertBefore(div, document.getElementById('prompt'));
            return div;
        }
        function createFileDiagDiv() {
            const div = document.createElement('div');
            div.id = 'fileDiag';
            document.getElementById('step3').insertBefore(div, document.getElementById('prompt'));
            return div;
        }
        function backToStep2() { showStep(2); }
        // toStep4: всегда подставляем всё содержимое файла в системный промпт, RAG отключён
        function toStep4() {
            sessionStorage.setItem('chatModel', 'openrouter');
            sessionStorage.setItem('openrouterKey', document.getElementById('openrouterKey').value.trim());
            sessionStorage.setItem('openrouterModel', document.getElementById('openrouterModel').value.trim());
            const userPrompt = document.getElementById('prompt').value.trim();
            const uploaded = sessionStorage.getItem('uploadedData');
            let fullPrompt = userPrompt;
            if (uploaded) {
                let fileData = '';
                try {
                    const data = JSON.parse(uploaded);
                    if (Array.isArray(data)) {
                        fileData = Array.isArray(data[0])
                            ? data.map(row => row.join(' | ')).join('\n')
                            : data.join('\n');
                    } else {
                        fileData = String(data);
                    }
                } catch { fileData = uploaded; }
                fullPrompt = `Пользователь загрузил файл. Вот его содержимое:\n${fileData}\n\n${userPrompt}`;
            }
            sessionStorage.setItem('systemPrompt', fullPrompt);
            showStep(4);
        }
        // На шаге 2 добавим кнопку сброса данных
        function resetFileData() {
            sessionStorage.removeItem('uploadedData');
            sessionStorage.removeItem('systemPrompt');
            sessionStorage.removeItem('ragChunks');
            sessionStorage.removeItem('ragEmbeddings');
            document.getElementById('datafile').value = '';
            document.getElementById('filePreview').innerHTML = '';
        }
        window.onload = function() { 
            showStep(0);
            // Подключаем обработчик для загрузки файла
            const datafileInput = document.getElementById('datafile');
            if (datafileInput) {
                datafileInput.addEventListener('change', handleFileUpload);
            }
        };
        document.getElementById('appAvatar')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    document.getElementById('avatarPreview').innerHTML = `<img src="${ev.target.result}" alt="avatar">`;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('avatarPreview').innerHTML = '';
            }
        });
        function getSelectedAvatar() {
            const sel = document.querySelector('.avatar-option.selected');
            return sel ? sel.getAttribute('data-avatar') : '🤖';
        }
        let editingAppIndex = null;
        function openModal(app, idx) {
            document.getElementById('modalAvatar').textContent = app.avatar;
            document.getElementById('modalTitle').textContent = app.name;
            document.getElementById('modalDate').textContent = 'создано ' + app.date;
            document.getElementById('modalDesc').textContent = app.desc;
            document.getElementById('appModal').style.display = 'flex';
            editingAppIndex = idx;
            document.getElementById('editAppBtn').onclick = function() { editApp(idx); };
            document.getElementById('deleteAppBtn').onclick = function() { deleteApp(idx); };
            // Показываем кнопку "Опубликовать", если приложение ещё не опубликовано
            let myApps = JSON.parse(localStorage.getItem('myApps') || '[]');
            let colleaguesApps = JSON.parse(localStorage.getItem('colleaguesApps') || '[]');
            const isPublished = colleaguesApps.some(a => a.name === app.name && a.date === app.date);
            const publishBtn = document.getElementById('publishAppBtn');
            if (!isPublished) {
                publishBtn.style.display = 'inline-block';
                publishBtn.onclick = function() { publishApp(idx); };
            } else {
                publishBtn.style.display = 'none';
            }
        }
        function closeModal() {
            document.getElementById('appModal').style.display = 'none';
        }
        function deleteApp(idx) {
            if (!confirm('Удалить это приложение?')) return;
            let myApps = JSON.parse(localStorage.getItem('myApps') || '[]');
            myApps.splice(idx, 1);
            localStorage.setItem('myApps', JSON.stringify(myApps));
            closeModal();
            renderMyApps();
        }
        function editApp(idx) {
            let myApps = JSON.parse(localStorage.getItem('myApps') || '[]');
            const app = myApps[idx];
            closeModal();
            // Заполняем мастер данными приложения
            showStep(1);
            // аватарка
            document.querySelectorAll('.avatar-option').forEach(a => {
                a.classList.toggle('selected', a.getAttribute('data-avatar') === app.avatar);
            });
            // название
            document.getElementById('appName').value = app.name;
            // цель
            document.getElementById('goal').value = app.desc;
            // Сохраняем индекс редактируемого приложения
            sessionStorage.setItem('editingAppIdx', idx);
        }
        function createApp() {
            const avatar = getSelectedAvatar();
            const name = document.getElementById('appName').value || 'Без названия';
            const desc = document.getElementById('goal').value || '';
            const now = new Date();
            const date = now.toLocaleDateString('ru-RU');
            let myApps = JSON.parse(localStorage.getItem('myApps') || '[]');
            let colleaguesApps = JSON.parse(localStorage.getItem('colleaguesApps') || '[]');
            const editingIdx = sessionStorage.getItem('editingAppIdx');
            const editingColleagueIdx = sessionStorage.getItem('editingColleagueAppIdx');
            if (editingIdx !== null && editingIdx !== undefined) {
                myApps[editingIdx] = { avatar, name, desc, date };
                sessionStorage.removeItem('editingAppIdx');
            } else if (editingColleagueIdx !== null && editingColleagueIdx !== undefined) {
                colleaguesApps[editingColleagueIdx] = { avatar, name, desc, date };
                sessionStorage.removeItem('editingColleagueAppIdx');
            } else {
                myApps.unshift({ avatar, name, desc, date });
            }
            localStorage.setItem('myApps', JSON.stringify(myApps));
            localStorage.setItem('colleaguesApps', JSON.stringify(colleaguesApps));
            document.getElementById('createMsg').style.display = 'block';
            setTimeout(()=>{
                document.getElementById('createMsg').style.display = 'none';
                backToMain();
                renderMyApps();
                renderColleaguesApps();
            }, 900);
        }
        function renderMyApps() {
            let myApps = JSON.parse(localStorage.getItem('myApps') || '[]');
            const container = document.getElementById('myApps');
            if (!container) return;
            container.innerHTML = myApps.length === 0 ? '<div style="color:#888;">Нет созданных приложений</div>' : '';
            myApps.forEach((app, idx) => {
                const el = document.createElement('div');
                el.className = 'app-card';
                el.innerHTML = `
                    <button class="app-info-btn top-right" title="Информация" aria-label="Информация"><b>...</b></button>
                    <div class="app-title">${app.avatar} ${app.name}</div>
                    <div class="app-meta">создано ${app.date}</div>
                    <div class="app-desc">${app.desc}</div>
                    <div class="app-card-actions"><a href="#" class="app-link">Открыть</a></div>
                `;
                el.querySelector('.app-link').addEventListener('click', function(e) {
                    e.preventDefault();
                    // Сохраняем данные приложения во временное хранилище и открываем chat.html
                    sessionStorage.setItem('currentApp', JSON.stringify(app));
                    window.open('chat.html', '_blank');
                });
                el.querySelector('.app-info-btn').addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal(app, idx);
                });
                container.appendChild(el);
            });
        }
        function renderColleaguesApps() {
            let colleaguesApps = JSON.parse(localStorage.getItem('colleaguesApps') || '[]');
            const container = document.getElementById('colleaguesApps');
            if (!container) return;
            container.innerHTML = colleaguesApps.length === 0 ? '<div style="color:#888;">Нет приложений коллег</div>' : '';
            colleaguesApps.forEach((app, idx) => {
                const el = document.createElement('div');
                el.className = 'app-card';
                el.innerHTML = `
                    <button class="app-info-btn top-right" title="Информация" aria-label="Информация"><b>...</b></button>
                    <div class="app-title">${app.avatar} ${app.name}</div>
                    <div class="app-meta">создано ${app.date}</div>
                    <div class="app-desc">${app.desc}</div>
                    <div class="app-card-actions"><a href="#" class="app-link">Открыть</a></div>
                `;
                el.querySelector('.app-link').addEventListener('click', function(e) {
                    e.preventDefault();
                    sessionStorage.setItem('currentApp', JSON.stringify(app));
                    window.open('chat.html', '_blank');
                });
                el.querySelector('.app-info-btn').addEventListener('click', function(e) {
                    e.preventDefault();
                    openColleagueModal(app, idx);
                });
                container.appendChild(el);
            });
        }
        function openColleagueModal(app, idx) {
            document.getElementById('modalAvatar').textContent = app.avatar;
            document.getElementById('modalTitle').textContent = app.name;
            document.getElementById('modalDate').textContent = 'создано ' + app.date;
            document.getElementById('modalDesc').textContent = app.desc;
            document.getElementById('appModal').style.display = 'flex';
            editingAppIndex = idx;
            document.getElementById('editAppBtn').onclick = function() { editColleagueApp(idx); };
            document.getElementById('deleteAppBtn').onclick = function() { deleteColleagueApp(idx); };
        }
        function editColleagueApp(idx) {
            let colleaguesApps = JSON.parse(localStorage.getItem('colleaguesApps') || '[]');
            const app = colleaguesApps[idx];
            closeModal();
            showStep(1);
            document.querySelectorAll('.avatar-option').forEach(a => {
                a.classList.toggle('selected', a.getAttribute('data-avatar') === app.avatar);
            });
            document.getElementById('appName').value = app.name;
            document.getElementById('goal').value = app.desc;
            sessionStorage.setItem('editingColleagueAppIdx', idx);
        }
        function deleteColleagueApp(idx) {
            if (!confirm('Удалить это приложение коллеги?')) return;
            let colleaguesApps = JSON.parse(localStorage.getItem('colleaguesApps') || '[]');
            colleaguesApps.splice(idx, 1);
            localStorage.setItem('colleaguesApps', JSON.stringify(colleaguesApps));
            closeModal();
            renderColleaguesApps();
        }
        function publishApp(idx) {
            let myApps = JSON.parse(localStorage.getItem('myApps') || '[]');
            let colleaguesApps = JSON.parse(localStorage.getItem('colleaguesApps') || '[]');
            const app = myApps[idx];
            // Копируем в коллеги, если ещё не опубликовано
            if (!colleaguesApps.some(a => a.name === app.name && a.date === app.date)) {
                colleaguesApps.unshift(app);
                localStorage.setItem('colleaguesApps', JSON.stringify(colleaguesApps));
            }
            closeModal();
            renderColleaguesApps();
        }
        document.addEventListener('DOMContentLoaded', function() {
            const avatars = document.querySelectorAll('.avatar-option');
            avatars.forEach(el => {
                el.addEventListener('click', function() {
                    avatars.forEach(a => a.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            renderMyApps();
            renderColleaguesApps();
            // OpenRouter token сохранение
            const openrouterKeyInput = document.getElementById('openrouterKey');
            if (openrouterKeyInput) {
                openrouterKeyInput.value = localStorage.getItem('openrouterKey') || '';
                openrouterKeyInput.addEventListener('input', function() {
                    localStorage.setItem('openrouterKey', this.value);
                    document.getElementById('openrouterKeySaved').style.display = 'inline';
                    setTimeout(()=>{document.getElementById('openrouterKeySaved').style.display = 'none';}, 1200);
                });
            }
        });
        // Закрытие модального окна по клику вне контента
        window.onclick = function(event) {
            const modal = document.getElementById('appModal');
            if (event.target === modal) closeModal();
        }
        // Чат-страница (SPA)
        function openChatPage(app) {
            document.body.innerHTML = '';
            const chatTemplate = document.getElementById('chatPageTemplate').content.cloneNode(true);
            chatTemplate.getElementById('chatAvatar').textContent = app.avatar;
            chatTemplate.getElementById('chatTitle').textContent = app.name;
            document.body.appendChild(chatTemplate);
            window.scrollTo(0,0);
        }
        // Демо-чат: добавление сообщений
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            const chatMessages = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = msg;
            chatMessages.appendChild(userMsg);
            input.value = '';
            setTimeout(()=>{
                const botMsg = document.createElement('div');
                botMsg.className = 'chat-message bot';
                botMsg.textContent = 'ИИ (демо): Я получил ваше сообщение: ' + msg;
                chatMessages.appendChild(botMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 600);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        async function testOpenRouterKey() {
            const token = document.getElementById('openrouterKey').value.trim();
            const model = document.getElementById('openrouterModel').value.trim();
            const resultDiv = document.getElementById('openrouterTestResult');
            resultDiv.textContent = 'Проверка...';
            if (!token || !model) {
                resultDiv.textContent = 'Введите ключ и модель.';
                return;
            }
            try {
                const resp = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: 'Привет! Это тест.' }],
                        max_tokens: 50
                    })
                });
                if (!resp.ok) {
                    const err = await resp.text();
                    resultDiv.textContent = 'Ошибка: ' + err;
                    return;
                }
                const data = await resp.json();
                resultDiv.textContent = 'Ответ: ' + (data.choices && data.choices[0]?.message?.content || JSON.stringify(data));
            } catch (e) {
                resultDiv.textContent = 'Ошибка: ' + e;
            }
        }
        // Проверка размера файла и предупреждение на шаге 2 (по uploadedFullText)
        let fileTooLarge = false;
        function checkFileSizeAlert() {
            const fullText = sessionStorage.getItem('uploadedFullText') || '';
            const alertDiv = document.getElementById('fileSizeAlert') || createFileSizeAlertDiv();
            let len = fullText.length;
            if (len > 20000) {
                alertDiv.style.display = 'block';
                alertDiv.innerHTML = `<b style='color:#c00;'>Файл слишком большой (&gt; 20 000 символов)! Уменьшите размер файла или загрузите другой.</b>`;
                fileTooLarge = true;
            } else {
                alertDiv.style.display = 'none';
                fileTooLarge = false;
            }
            // Блокируем/разблокируем кнопку "Далее"
            const nextBtn = document.querySelector('#step2 .nav-btns button:last-child');
            if (nextBtn) nextBtn.disabled = fileTooLarge;
        }
        function createFileSizeAlertDiv() {
            let div = document.getElementById('fileSizeAlert');
            if (!div) {
                div = document.createElement('div');
                div.id = 'fileSizeAlert';
                div.style = 'margin:10px 0 0 0; color:#c00; font-size:1.05em; display:none;';
                document.getElementById('step2').insertBefore(div, document.getElementById('filePreview').nextSibling);
            }
            return div;
        }
        async function handleFileUpload(e) {
            sessionStorage.removeItem('uploadedData');
            sessionStorage.removeItem('uploadedFullText');
            const file = e.target.files[0];
            if (!file) return;
            const previewDiv = document.getElementById('filePreview') || createPreviewDiv();
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'csv') {
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        showPreview(results.data.slice(0, 5), previewDiv);
                        sessionStorage.setItem('uploadedData', JSON.stringify(results.data));
                        // Сохраняем полный текст для лимита
                        const fullText = results.data.map(row => Object.values(row).join(' ')).join('\n');
                        sessionStorage.setItem('uploadedFullText', fullText);
                        checkFileSizeAlert();
                    },
                    error: function(err) {
                        previewDiv.textContent = 'Ошибка чтения CSV: ' + err;
                        sessionStorage.setItem('uploadedFullText', '');
                        checkFileSizeAlert();
                    }
                });
            } else if (ext === 'txt') {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    const lines = ev.target.result.split('\n');
                    showPreview(lines.slice(0, 10), previewDiv);
                    sessionStorage.setItem('uploadedData', JSON.stringify(lines.slice(0, 10)));
                    sessionStorage.setItem('uploadedFullText', ev.target.result);
                    checkFileSizeAlert();
                };
                reader.readAsText(file);
            } else if (ext === 'xlsx' || ext === 'xls') {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    const data = new Uint8Array(ev.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    showPreview(json.slice(0, 5), previewDiv);
                    sessionStorage.setItem('uploadedData', JSON.stringify(json));
                    // Сохраняем полный текст для лимита
                    const fullText = json.map(row => row.join(' ')).join('\n');
                    sessionStorage.setItem('uploadedFullText', fullText);
                    checkFileSizeAlert();
                };
                reader.readAsArrayBuffer(file);
            } else if (ext === 'docx') {
                const reader = new FileReader();
                reader.onload = async function(ev) {
                    try {
                        const arrayBuffer = ev.target.result;
                        const result = await mammoth.extractRawText({arrayBuffer});
                        const text = result.value;
                        showPreview(text.split('\n').slice(0, 10), previewDiv);
                        sessionStorage.setItem('uploadedData', JSON.stringify(text.split('\n').slice(0, 10)));
                        sessionStorage.setItem('uploadedFullText', text);
                        checkFileSizeAlert();
                    } catch (err) {
                        previewDiv.textContent = 'Ошибка чтения DOCX: ' + err;
                        sessionStorage.setItem('uploadedFullText', '');
                        checkFileSizeAlert();
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                previewDiv.textContent = 'Формат не поддерживается для предпросмотра.';
                sessionStorage.setItem('uploadedFullText', '');
                checkFileSizeAlert();
            }
        }
        function createPreviewDiv() {
            const div = document.createElement('div');
            div.id = 'filePreview';
            div.style = 'background:#f7faff; border-radius:8px; padding:10px 12px; margin-top:12px; font-size:0.98em; color:#333; max-height:180px; overflow:auto;';
            document.getElementById('step2').appendChild(div);
            return div;
        }
        function showPreview(data, previewDiv) {
            if (Array.isArray(data)) {
                previewDiv.innerHTML = '<b>Превью данных:</b><br>' + data.map(row => Array.isArray(row) ? row.join(' | ') : JSON.stringify(row)).join('<br>');
            } else {
                previewDiv.textContent = JSON.stringify(data, null, 2);
            }
        }
        // Восстанавливаю функцию showTab для переключения вкладок
        function showTab(tab) {
            document.getElementById('myApps').style.display = (tab === 'my') ? 'flex' : 'none';
            document.getElementById('colleaguesApps').style.display = (tab === 'colleagues') ? 'flex' : 'none';
            document.getElementById('myAppsTab').classList.toggle('active', tab === 'my');
            document.getElementById('colleaguesAppsTab').classList.toggle('active', tab === 'colleagues');
        }
    </script>
</head>
<body>
    <div class="container">
        <div id="main">
            <h1>Self-Service Ai</h1>
            <div style="margin-bottom: 28px;">
                <button class="btn" onclick="startWizard()">+ Создать новое приложение</button>
            </div>
            <div class="tabs">
                <button class="tab-btn active" id="myAppsTab" onclick="showTab('my')">Мои приложения</button>
                <button class="tab-btn" id="colleaguesAppsTab" onclick="showTab('colleagues')">Опубликованные приложения</button>
            </div>
            <div id="myApps" class="apps-list">
                <div class="app-card">
                    <div class="app-title">Анализ отзывов</div>
                    <div class="app-meta">создано 12.06.2024</div>
                    <div class="app-desc">ИИ анализирует отзывы клиентов и выделяет основные проблемы.</div>
                    <div class="app-card-actions"><a href="#" class="app-link">Открыть</a><button class="app-info-btn" title="Информация" aria-label="Информация"><b>...</b></button></div>
                </div>
            </div>
            <div id="colleaguesApps" class="apps-list" style="display:none;">
                <div class="app-card">
                    <div class="app-title">Генератор отчетов</div>
                    <div class="app-meta">Иван И., 10.06.2024</div>
                    <div class="app-desc">Автоматизация создания еженедельных отчетов по продажам.</div>
                    <div class="app-card-actions"><a href="#" class="app-link">Открыть</a><button class="app-info-btn" title="Информация" aria-label="Информация"><b>...</b></button></div>
                </div>
                <div class="app-card">
                    <div class="app-title">Резюме документов</div>
                    <div class="app-meta">Ольга П., 09.06.2024</div>
                    <div class="app-desc">ИИ создает краткое резюме загруженных документов.</div>
                    <div class="app-card-actions"><a href="#" class="app-link">Открыть</a><button class="app-info-btn" title="Информация" aria-label="Информация"><b>...</b></button></div>
                </div>
            </div>
        </div>
        <div id="step1" class="step" style="display:none;">
            <h2>Шаг 1: Оформление приложения</h2>
            <label>Аватарка приложения</label>
            <div id="avatarChoices" class="avatar-choices" style="margin-bottom:16px;">
                <div class="avatar-option selected" data-avatar="🤖">🤖</div>
                <div class="avatar-option" data-avatar="📊">📊</div>
                <div class="avatar-option" data-avatar="📝">📝</div>
                <div class="avatar-option" data-avatar="📈">📈</div>
                <div class="avatar-option" data-avatar="💡">💡</div>
            </div>
            <label for="appName">Название приложения</label>
            <input type="text" id="appName" placeholder="Введите название приложения" style="margin-bottom:14px;">
            <label for="goal">Для чего вы хотите создать приложение?</label>
            <textarea id="goal" placeholder="Например: анализировать отзывы клиентов, автоматизировать отчеты, ..."></textarea>
            <div class="nav-btns">
                <button class="btn" style="width:48%;" onclick="backToMain()">Назад</button>
                <button class="btn" style="width:48%;" onclick="toStep2()">Далее</button>
            </div>
        </div>
        <div id="step2" class="step" style="display:none;">
            <h2>Шаг 2: Загрузите ваши данные</h2>
            <label for="datafile">Загрузите файл с вашими данными (CSV, TXT, Excel, Word, PDF)</label>
            <input type="file" id="datafile" accept=".csv,.txt,.xlsx,.xls,.doc,.docx,.pdf">
            <button class="btn" style="background:#eee; color:#333; margin-top:8px; margin-bottom:8px;" onclick="resetFileData()">Сбросить данные</button>
            <div id="filePreview" style="background:#f7faff; border-radius:8px; padding:10px 12px; margin-top:12px; font-size:0.98em; color:#333; max-height:180px; overflow:auto;"></div>
            <div id="fileSizeAlert" style="margin:10px 0 0 0; color:#c00; font-size:1.05em; display:none;"></div>
            <div class="nav-btns">
                <button class="btn" style="width:48%;" onclick="backToStep1()">Назад</button>
                <button class="btn" style="width:48%;" onclick="toStep3()">Далее</button>
            </div>
        </div>
        <div id="step3" class="step" style="display:none;">
            <h2>Шаг 3: Настройте ИИ</h2>
            <label for="openrouterModel">Модель</label>
            <input type="text" id="openrouterModel" value="openai/gpt-3.5-turbo" style="width:100%; margin-bottom:10px;">
            <div id="openrouterKeyBlock" style="margin-top:10px;">
                <label for="openrouterKey">OpenRouter API-ключ</label>
                <input type="text" id="openrouterKey" placeholder="Введите OpenRouter API-ключ (org-...)" style="width:100%; margin-bottom:10px;">
                <button class="btn" type="button" style="width:100%; margin-bottom:8px;" onclick="testOpenRouterKey()">Проверить OpenRouter</button>
                <div id="openrouterKeySaved" style="color:green; font-size:0.97em; display:none;">Ключ сохранён!</div>
                <div id="openrouterTestResult" style="font-size:0.97em; margin-top:6px;"></div>
            </div>
            <label for="prompt" style="margin-top:14px;">Промпт/инструкция для ИИ</label>
            <textarea id="prompt" placeholder="Например: Проанализируй данные и выдели основные инсайты..."></textarea>
            <div class="nav-btns">
                <button class="btn" style="width:48%;" onclick="backToStep2()">Назад</button>
                <button class="btn" style="width:48%;" onclick="toStep4()">Далее</button>
            </div>
        </div>
        <div id="step4" class="step" style="display:none;">
            <h2>Шаг 4: Ваше приложение готово!</h2>
            <div style="background:#f1f5fb; border-radius:8px; padding:18px; margin-bottom:18px; color:#333;">
                <b>Демо-режим:</b> Здесь будет результат работы вашего приложения.<br>
                <span style="color:#888; font-size:0.98em;">(В реальной версии здесь появится вывод ИИ на ваших данных)</span>
            </div>
            <button class="btn" style="margin-bottom:12px;" onclick="createApp()">Создать приложение</button>
            <button class="btn" style="background:#eee; color:#333;" onclick="backToMain()">На главную</button>
            <div id="createMsg" style="color:green; text-align:center; margin-top:10px; display:none;">Приложение создано!</div>
        </div>
    </div>
    <div class="footer">&copy; 2025 Budtuev GenAi Constructor</div>
    <!-- Модальное окно просмотра приложения -->
    <div id="appModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalAvatar" class="modal-avatar"></div>
            <div id="modalTitle" class="modal-title"></div>
            <div id="modalDate" class="modal-date"></div>
            <div id="modalDesc" class="modal-desc"></div>
            <div class="modal-actions">
                <button class="btn" id="editAppBtn" style="margin-right:10px;">Редактировать</button>
                <button class="btn" id="deleteAppBtn" style="background:#ffeded; color:#c00;">Удалить</button>
                <button class="btn" id="publishAppBtn" style="background:#eaffea; color:#1a7f1a; display:none;">Опубликовать</button>
            </div>
        </div>
    </div>
    <!-- Шаблон страницы чата -->
    <template id="chatPageTemplate">
        <div class="chat-header">
            <span id="chatAvatar" class="chat-avatar"></span>
            <span id="chatTitle" class="chat-title"></span>
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="chat-message bot">Добро пожаловать! Это демо-чат вашего приложения.</div>
        </div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" class="chat-input" placeholder="Введите сообщение...">
            <button class="chat-send-btn" onclick="sendChatMessage()">Отправить</button>
        </div>
    </template>
</body>
</html> 