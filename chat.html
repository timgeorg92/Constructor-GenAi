<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7fa; margin: 0; padding: 0; }
        .chat-container { max-width: 480px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 16px #0002; padding: 0 0 24px 0; }
        .chat-header { display: flex; align-items: center; gap: 14px; background: #f1f5fb; padding: 22px 24px 14px 24px; border-radius: 16px 16px 0 0; box-shadow: 0 2px 8px #0001; }
        .chat-avatar { font-size: 2.2rem; background: #fff; border-radius: 50%; width: 54px; height: 54px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px #0001; }
        .chat-title { font-size: 1.18rem; font-weight: bold; }
        .chat-messages { min-height: 220px; max-height: 340px; overflow-y: auto; padding: 22px 24px 0 24px; background: #fff; border-radius: 0 0 0 0; }
        .chat-message { margin-bottom: 14px; padding: 12px 16px; border-radius: 12px; max-width: 80%; word-break: break-word; }
        .chat-message.bot { background: #f1f5fb; color: #333; align-self: flex-start; }
        .chat-message.user { background: #4f8cff; color: #fff; align-self: flex-end; margin-left: auto; }
        .chat-input-row { display: flex; gap: 10px; margin: 18px 24px 0 24px; }
        .chat-input { flex: 1; padding: 12px; border-radius: 8px; border: 1.2px solid #bcd0ee; font-size: 1.08rem; }
        .chat-send-btn { background: #4f8cff; color: #fff; border: none; border-radius: 8px; padding: 12px 22px; font-size: 1.08rem; cursor: pointer; transition: background 0.2s; }
        .chat-send-btn:hover { background: #2563eb; }
        .chat-back { position: absolute; left: 18px; top: 18px; background: #f1f5fb; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: #4f8cff; cursor: pointer; transition: background 0.2s; }
        .chat-back:hover { background: #e0eaff; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <button class="chat-back" onclick="window.close()" title="–ù–∞–∑–∞–¥">&#8592;</button>
            <span id="chatAvatar" class="chat-avatar"></span>
            <span id="chatTitle" class="chat-title"></span>
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="chat-message bot">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –≠—Ç–æ –¥–µ–º–æ-—á–∞—Ç –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</div>
        </div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="chat-send-btn" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
    <script>
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ sessionStorage
        const app = JSON.parse(sessionStorage.getItem('currentApp') || '{}');
        document.getElementById('chatAvatar').textContent = app.avatar || 'ü§ñ';
        document.getElementById('chatTitle').textContent = app.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        // –ü–æ–ª—É—á–∞–µ–º OpenAI/HF API-–∫–ª—é—á –∏ –º–æ–¥–µ–ª—å
        let openaiKey = localStorage.getItem('openaiKey') || sessionStorage.getItem('openaiKey') || '';
        let hfKey = localStorage.getItem('hfKey') || sessionStorage.getItem('hfKey') || '';
        let hfModel = localStorage.getItem('hfModel') || sessionStorage.getItem('hfModel') || 'mistralai/Mistral-7B-Instruct-v0.2';
        let chatModel = (sessionStorage.getItem('chatModel') || 'gpt-3.5');
        let openrouterKey = localStorage.getItem('openrouterKey') || sessionStorage.getItem('openrouterKey') || '';
        let openrouterModel = localStorage.getItem('openrouterModel') || sessionStorage.getItem('openrouterModel') || 'openrouter/cognitive-compute/llama-3-8b-instruct';
        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        sessionStorage.removeItem('chatHistory');
        sessionStorage.removeItem('ragChunks');
        sessionStorage.removeItem('ragEmbeddings');
        // systemPrompt –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º –∏–∑ sessionStorage (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π)
        let systemPrompt = sessionStorage.getItem('systemPrompt') || '';
        let chatHistory = JSON.parse(sessionStorage.getItem('chatHistory') || 'null');
        if (!chatHistory) {
            chatHistory = [];
            if (systemPrompt) {
                chatHistory.push({ role: 'system', content: systemPrompt });
            }
        }
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π conversation_id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞ (–ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ UUID)
        let conversationId = sessionStorage.getItem('conversationId');
        if (!conversationId) {
            const fileName = app && app.name ? app.name : '';
            conversationId = fileName ? 'conv_' + btoa(unescape(encodeURIComponent(fileName))).replace(/[^a-zA-Z0-9]/g, '').slice(0, 16) : 'conv_' + Math.random().toString(36).slice(2, 12);
            sessionStorage.setItem('conversationId', conversationId);
        }
        // –£—Å–∏–ª–∏–≤–∞–µ–º systemPrompt
        if (systemPrompt) {
            systemPrompt = `–ò–≥–Ω–æ—Ä–∏—Ä—É–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∏–∞–ª–æ–≥–∏. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ —ç—Ç–∏–º –¥–∞–Ω–Ω—ã–º.\n${systemPrompt}`;
        }
        // –î–µ–º–æ-—á–∞—Ç: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            const chatMessages = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = msg;
            chatMessages.appendChild(userMsg);
            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π: —Ç–æ–ª—å–∫–æ systemPrompt –∏ user message
            let messages = [];
            if (systemPrompt) {
                messages.push({ role: 'system', content: systemPrompt });
            }
            messages.push({ role: 'user', content: msg });
            // OpenRouter
            if (chatModel === 'openrouter' && openrouterKey && openrouterModel) {
                const botMsg = document.createElement('div');
                botMsg.className = 'chat-message bot';
                botMsg.textContent = '...';
                chatMessages.appendChild(botMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                try {
                    const resp = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + openrouterKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: openrouterModel,
                            messages: messages,
                            max_tokens: 100,
                            conversation_id: conversationId
                        })
                    });
                    if (!resp.ok) {
                        const err = await resp.text();
                        botMsg.textContent = '–û—à–∏–±–∫–∞: ' + err;
                        return;
                    }
                    const data = await resp.json();
                    const answer = data.choices && data.choices[0]?.message?.content || JSON.stringify(data);
                    botMsg.textContent = answer;
                } catch (e) {
                    botMsg.textContent = '–û—à–∏–±–∫–∞: ' + e;
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return;
            }
            // Hugging Face
            if (chatModel === 'hf-mistral' && hfKey && hfModel) {
                const botMsg = document.createElement('div');
                botMsg.className = 'chat-message bot';
                botMsg.textContent = '...';
                chatMessages.appendChild(botMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                try {
                    const resp = await fetch(`https://api-inference.huggingface.co/models/${hfModel}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + hfKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ inputs: msg })
                    });
                    if (!resp.ok) {
                        const err = await resp.text();
                        botMsg.textContent = '–û—à–∏–±–∫–∞: ' + err;
                        return;
                    }
                    const data = await resp.json();
                    botMsg.textContent = data[0]?.generated_text || JSON.stringify(data);
                } catch (e) {
                    botMsg.textContent = '–û—à–∏–±–∫–∞: ' + e;
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return;
            }
            // OpenAI
            if (chatModel === 'gpt-3.5' && openaiKey) {
                const botMsg = document.createElement('div');
                botMsg.className = 'chat-message bot';
                botMsg.textContent = '...';
                chatMessages.appendChild(botMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                try {
                    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + openaiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{ role: 'user', content: msg }],
                            max_tokens: 100
                        })
                    });
                    if (!resp.ok) {
                        const err = await resp.text();
                        botMsg.textContent = '–û—à–∏–±–∫–∞: ' + err;
                        return;
                    }
                    const data = await resp.json();
                    botMsg.textContent = data.choices && data.choices[0]?.message?.content || JSON.stringify(data);
                } catch (e) {
                    botMsg.textContent = '–û—à–∏–±–∫–∞: ' + e;
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return;
            }
            // –î–µ–º–æ-–æ—Ç–≤–µ—Ç
            setTimeout(()=>{
                const botMsg = document.createElement('div');
                botMsg.className = 'chat-message bot';
                botMsg.textContent = '–ò–ò (–¥–µ–º–æ): –Ø –ø–æ–ª—É—á–∏–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + msg;
                chatMessages.appendChild(botMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 600);
        }
        document.getElementById('chatInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendChatMessage();
        });
    </script>
</body>
</html> 